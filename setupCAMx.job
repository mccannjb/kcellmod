#!/bin/bash

## This script accomplishes three separate tasks:
##  1) Modifies a given base namelist file, creating
##     a series of namelist files which correspond to
##     the different groups of sensitivity parameters
##     generated by kcellmod.
##  2) Copy the appropriate kcellmod-generate ptsrc
##     file into its proper run directory
##  3) Submits all of the namelist files as jobs on
##     the research cluster with appropriate logfile
##     outputs.
##
## TODO: Explicitly call the directory from which to
##       pull .camx and the .namelist base file.
##

RUNFILE='_AUG.PITTSB01.GRP00.namelist'	# Base namelist file
RUNNAME='PITTSB01'	# Episode/Run name used for the model runs
NGROUPS=`ls *.camx | wc -l | sed -e 's/\ //g'`	# Count number of camx ptsrc files in directory
WRKDIR="/nas02/home/m/c/mccannjb/netscr/EPA"	# Base directory for model inputs/outputs/etc

mkdir ${WRKDIR}/scripts/${RUNNAME}	# Create the episode directory in the scripts directory

for i in `seq 1 $NGROUPS`	# For all of the .camx files in the directory...
do
 GRP=`printf "%02d" ${i}`	# Format digits properly
 NEWFILE=`echo $RUNFILE | sed -e "s/GRP[0-9][0-9]/GRP${GRP}/g"`	# Create new filename with modified digit
 cp ${RUNFILE} ${NEWFILE}	# Create copied file with new filename
 sed -i -e "s/GROUPN\t[0-9][0-9]/GROUPN\t${GRP}/g" ${NEWFILE}	# Modify the new runfile for new group
 mv ${NEWFILE} ${WRKDIR}/scripts/${RUNNAME}/	# Place namelist file in proper run folder
 NEWPTFILE=`echo *.${i}.camx | sed -e "s/\.${i}\./\.${GRP}\./g"`	# Change name of ptsrc file
 cp *.${i}.camx ${WRKDIR}/12EUS1_F/ddm/${RUNNAME}/GRP${GRP}/ptsrc/$NEWPTFILE	# Place ptsrc file in proper folder
done

cd ${WRKDIR}/scripts/${RUNNAME}

for file in *.namelist
do
 bsub -x -n 8 -R "span[hosts=1]" -o ../../runlogs/$(echo ${file} | sed "s/\.namelist//g")-%J.log ./${file}
done
